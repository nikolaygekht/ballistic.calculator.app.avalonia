using Avalonia;
using Avalonia.Controls;
using Avalonia.Input;
using Avalonia.Interactivity;
using BallisticCalculator;
using BallisticCalculator.Controls.Controllers;
using BallisticCalculator.Controls.Models;
using System;
using System.Globalization;
using System.Linq;

namespace BallisticCalculator.Controls.Controls;

public partial class BallisticCoefficientControl : UserControl
{
    private readonly BallisticCoefficientController _controller;

    // Precision transparency tracking (WinForms pattern - lines 106-109)
    private BallisticCoefficient? _originalValue = null;
    private string? _originalText = null;
    private DragTableInfo? _originalTable = null;

    // NumericPart, TablePart, and ValidationErrorText are generated by Avalonia
    // from x:Name attributes in XAML and are accessible as internal

    #region Styled Properties

    public static readonly StyledProperty<BallisticCoefficient?> ValueProperty =
        AvaloniaProperty.Register<BallisticCoefficientControl, BallisticCoefficient?>(
            nameof(Value),
            defaultBindingMode: Avalonia.Data.BindingMode.TwoWay);

    public static readonly StyledProperty<double> IncrementProperty =
        AvaloniaProperty.Register<BallisticCoefficientControl, double>(
            nameof(Increment), 0.001);

    public static readonly StyledProperty<double> MinimumProperty =
        AvaloniaProperty.Register<BallisticCoefficientControl, double>(
            nameof(Minimum), 0.001);

    public static readonly StyledProperty<double> MaximumProperty =
        AvaloniaProperty.Register<BallisticCoefficientControl, double>(
            nameof(Maximum), 2.0);

    public static readonly StyledProperty<int?> DecimalPointsProperty =
        AvaloniaProperty.Register<BallisticCoefficientControl, int?>(
            nameof(DecimalPoints), 3);

    public static readonly StyledProperty<double> TablePartWidthProperty =
        AvaloniaProperty.Register<BallisticCoefficientControl, double>(
            nameof(TablePartWidth), 80.0);

    public static readonly StyledProperty<CultureInfo> CultureProperty =
        AvaloniaProperty.Register<BallisticCoefficientControl, CultureInfo>(
            nameof(Culture), CultureInfo.InvariantCulture);

    #endregion

    #region Properties

    public BallisticCoefficient? Value
    {
        get => GetValue(ValueProperty);
        set => SetValue(ValueProperty, value);
    }

    public double Increment
    {
        get => GetValue(IncrementProperty);
        set => SetValue(IncrementProperty, value);
    }

    public double Minimum
    {
        get => GetValue(MinimumProperty);
        set => SetValue(MinimumProperty, value);
    }

    public double Maximum
    {
        get => GetValue(MaximumProperty);
        set => SetValue(MaximumProperty, value);
    }

    public int? DecimalPoints
    {
        get => GetValue(DecimalPointsProperty);
        set => SetValue(DecimalPointsProperty, value);
    }

    public double TablePartWidth
    {
        get => GetValue(TablePartWidthProperty);
        set => SetValue(TablePartWidthProperty, value);
    }

    public CultureInfo Culture
    {
        get => GetValue(CultureProperty);
        set => SetValue(CultureProperty, value);
    }

    public bool IsEmpty => string.IsNullOrWhiteSpace(NumericPart?.Text);

    #endregion

    #region Events

    public event EventHandler? Changed;

    #endregion

    #region Constructor & Initialization

    public BallisticCoefficientControl()
    {
        _controller = new BallisticCoefficientController();
        InitializeComponent();

        // Initialize drag tables
        UpdateTables();

        // Set initial TablePart width
        if (TablePart != null)
            TablePart.Width = TablePartWidth;

        // Wire up events
        WireEvents();

        // Sync properties to controller
        SyncPropertiesToController();
    }

    private void UpdateTables()
    {
        if (TablePart == null) return;

        TablePart.Items.Clear();
        var tables = _controller.GetDragTables(out int defaultIndex);
        foreach (var table in tables)
            TablePart.Items.Add(table);
        TablePart.SelectedIndex = defaultIndex;
    }

    private void WireEvents()
    {
        // Focus management
        this.GotFocus += OnControlGotFocus;

        // Keyboard handling
        if (NumericPart != null)
        {
            NumericPart.KeyDown += NumericPart_KeyDown;
            NumericPart.AddHandler(TextInputEvent, NumericPart_TextInput, RoutingStrategies.Tunnel);
            NumericPart.TextChanged += NumericPart_TextChanged;
        }

        // ComboBox changes
        if (TablePart != null)
        {
            TablePart.SelectionChanged += TablePart_SelectionChanged;
        }

        // Property changed
        this.PropertyChanged += OnPropertyChanged;
    }

    private void SyncPropertiesToController()
    {
        _controller.Increment = Increment;
        _controller.Minimum = Minimum;
        _controller.Maximum = Maximum;
        _controller.DecimalPoints = DecimalPoints;
    }

    #endregion

    #region Value Property Logic (Precision Transparency)

    // WinForms pattern - lines 110-118
    private BallisticCoefficient? GetValueInternal()
    {
        // If text and table unchanged, return original value (precision transparency!)
        if (_originalValue.HasValue &&
            _originalText == NumericPart?.Text &&
            _originalTable != null &&
            TablePart?.SelectedItem is DragTableInfo currentTable &&
            currentTable.Value == _originalTable.Value)
        {
            return _originalValue;
        }

        // Otherwise parse from current text
        if (TablePart?.SelectedItem is not DragTableInfo table)
            return null;

        return _controller.Value(NumericPart?.Text ?? "", table, DecimalPoints, Culture);
    }

    // WinForms pattern - lines 119-137
    private void SetValueInternal(BallisticCoefficient? value)
    {
        if (NumericPart == null || TablePart == null)
            return;

        if (value == null)
        {
            NumericPart.Text = "";
            _originalTable = (DragTableInfo?)TablePart.SelectedItem;
            _originalText = "";
            _originalValue = null;
            ClearValidationError();
            return;
        }

        // Parse value to text and table
        _controller.ParseValue(value.Value, out string text, out DragTableInfo table, DecimalPoints, Culture);

        // Update UI
        NumericPart.Text = text;
        TablePart.SelectedItem = table;

        // Store original for precision transparency
        _originalText = text;
        _originalTable = table;
        _originalValue = value;

        // Validate
        ValidateValue();
    }

    private void OnPropertyChanged(object? sender, AvaloniaPropertyChangedEventArgs e)
    {
        if (e.Property == ValueProperty)
        {
            SetValueInternal((BallisticCoefficient?)e.NewValue);
        }
        else if (e.Property == IncrementProperty)
        {
            _controller.Increment = (double)e.NewValue!;
        }
        else if (e.Property == MinimumProperty)
        {
            _controller.Minimum = (double)e.NewValue!;
            ValidateValue();
        }
        else if (e.Property == MaximumProperty)
        {
            _controller.Maximum = (double)e.NewValue!;
            ValidateValue();
        }
        else if (e.Property == DecimalPointsProperty)
        {
            _controller.DecimalPoints = (int?)e.NewValue;
        }
        else if (e.Property == TablePartWidthProperty)
        {
            if (TablePart != null)
                TablePart.Width = (double)e.NewValue!;
        }
    }

    #endregion

    #region Focus Management

    private void OnControlGotFocus(object? sender, GotFocusEventArgs e)
    {
        // When control receives focus, focus NumericPart first
        NumericPart?.Focus();
    }

    #endregion

    #region Keyboard Input Handling

    // WinForms pattern - lines 185-192
    private void NumericPart_TextInput(object? sender, TextInputEventArgs e)
    {
        if (string.IsNullOrEmpty(e.Text) || NumericPart == null)
            return;

        foreach (char c in e.Text)
        {
            if (c == '\b') // Backspace
                continue;

            if (!_controller.AllowKeyInEditor(
                NumericPart.Text ?? "",
                NumericPart.CaretIndex,
                NumericPart.SelectionEnd - NumericPart.SelectionStart,
                c,
                Culture))
            {
                e.Handled = true;
                return;
            }
        }
    }

    // WinForms pattern - lines 206-220
    private void NumericPart_KeyDown(object? sender, KeyEventArgs e)
    {
        if (NumericPart == null || TablePart == null)
            return;

        if (e.Key == Key.Up && e.KeyModifiers == KeyModifiers.None)
        {
            DoIncrement(1);
            e.Handled = true;
        }
        else if (e.Key == Key.Down && e.KeyModifiers == KeyModifiers.None)
        {
            DoIncrement(-1);
            e.Handled = true;
        }
        else if (e.Key == Key.Tab && e.KeyModifiers == KeyModifiers.None)
        {
            // Tab from NumericPart moves to TablePart
            TablePart.Focus();
            e.Handled = true;
        }
    }

    private void DoIncrement(int direction)
    {
        if (NumericPart == null || TablePart?.SelectedItem is not DragTableInfo table)
            return;

        bool increment = direction > 0;
        NumericPart.Text = _controller.IncrementValue(
            NumericPart.Text ?? "",
            table,
            increment,
            Culture);

        // Raise Changed event
        RaiseChanged();
    }

    #endregion

    #region Validation

    private void ValidateValue()
    {
        if (NumericPart == null)
            return;

        var value = GetValueInternal();

        if (string.IsNullOrWhiteSpace(NumericPart.Text))
        {
            ClearValidationError();
            return;
        }

        if (value == null)
        {
            ShowValidationError("Value must be a valid number");
            return;
        }

        if (value.Value.Value < Minimum)
        {
            ShowValidationError($"Value must be at least {Minimum}");
            return;
        }

        if (value.Value.Value > Maximum)
        {
            ShowValidationError($"Value must not exceed {Maximum}");
            return;
        }

        ClearValidationError();
    }

    private void ShowValidationError(string message)
    {
        if (ValidationErrorText == null)
            return;

        ValidationErrorText.Text = message;
        ValidationErrorText.IsVisible = true;

        // Also add visual indicator to TextBox
        if (NumericPart != null)
        {
            NumericPart.BorderBrush = Avalonia.Media.Brushes.Red;
            NumericPart.BorderThickness = new Thickness(2);
        }
    }

    private void ClearValidationError()
    {
        if (ValidationErrorText != null)
        {
            ValidationErrorText.IsVisible = false;
        }

        // Reset TextBox border
        if (NumericPart != null)
        {
            NumericPart.ClearValue(TextBox.BorderBrushProperty);
            NumericPart.ClearValue(TextBox.BorderThicknessProperty);
        }
    }

    #endregion

    #region Change Events

    // WinForms pattern - lines 196-204
    private void NumericPart_TextChanged(object? sender, TextChangedEventArgs e)
    {
        // Mark as modified when text changes (user edit)
        if (_originalText != null && NumericPart?.Text != _originalText)
        {
            _originalValue = null;
            _originalText = null;
            _originalTable = null;
        }

        ValidateValue();
        RaiseChanged();
    }

    private void TablePart_SelectionChanged(object? sender, SelectionChangedEventArgs e)
    {
        RaiseChanged();
    }

    private void RaiseChanged()
    {
        // Update Value property (triggers precision logic)
        var newValue = GetValueInternal();
        if (!Equals(newValue, Value))
        {
            SetCurrentValue(ValueProperty, newValue);
        }

        // Raise Changed event
        Changed?.Invoke(this, EventArgs.Empty);
    }

    #endregion

    #region Public Helper Methods

    // WinForms pattern - lines 170-178
    public void ForceCulture(CultureInfo cultureInfo)
    {
        BallisticCoefficient? value = null;
        if (!IsEmpty)
            value = Value;

        Culture = cultureInfo;

        if (value != null)
            Value = value;
    }

    /// <summary>
    /// Gets the available drag table names in order (for debugging/testing)
    /// </summary>
    public IEnumerable<string> GetAvailableTableNames()
    {
        return TablePart?.Items.Cast<DragTableInfo>().Select(t => t.Name) ?? Enumerable.Empty<string>();
    }

    #endregion
}
